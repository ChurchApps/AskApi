# OpenAI API Integration Documentation

## Overview

This document describes the token-efficient OpenAI integration system that enables natural language queries across all microservice APIs in the church management system. The system converts 298KB of swagger documentation into a lightweight, discoverable format that OpenAI can use to intelligently route and execute API calls.

## Problem Statement

- **Challenge**: Large swagger files (298KB total) consume too many tokens for OpenAI context
- **Need**: Enable OpenAI to query any data across 7 microservice APIs efficiently
- **Solution**: Two-tier system with lightweight route discovery + on-demand detail loading

## Architecture

### High-Level Flow
```
User Query → OpenAI Analysis → Route Discovery → Detail Loading → API Call Generation
```

### Components

1. **Swagger Preprocessing** - Converts large swagger files into optimized chunks
2. **Route Discovery Service** - Token-efficient route indexing and search
3. **OpenAI Query Service** - Natural language to API call orchestration
4. **REST API Endpoints** - HTTP interface for the system

## File Structure

```
src/
├── services/
│   ├── RouteDiscoveryService.ts    # Route indexing and search
│   ├── OpenAIQueryService.ts       # OpenAI orchestration
│   └── index.ts                    # Service exports
├── helpers/
│   └── SwaggerHelper.ts            # Enhanced with optimization methods
├── controllers/
│   └── QueryController.ts          # API endpoints
└── tools/
    └── preprocessSwagger.ts        # Swagger preprocessing script

config/
└── optimized/                     # Generated by preprocessing
    ├── route-index.json           # Lightweight route discovery (10-20KB)
    └── route-details/             # Individual route specifications
        ├── attendanceapi.GET._attendancerecords_trend.json
        ├── membershipapi.GET._people.json
        └── ... (315 total files)
```

## Setup and Usage

### 1. Initial Setup

```bash
# Install dependencies (already done)
npm install

# Preprocess swagger files into optimized format
npm run preprocess-swagger
```

This generates:
- `config/optimized/route-index.json` - 315 routes with summaries
- `config/optimized/route-details/*.json` - Individual route specifications

### 2. API Endpoints

#### POST /query/discover-routes
Main endpoint for OpenAI integration. Converts natural language queries into API calls.

**Request:**
```json
{
  "query": "Show me attendance trends for the main campus"
}
```

**Response:**
```json
{
  "intent": "Get attendance trend data filtered by campus",
  "routes": [
    {
      "service": "attendanceapi",
      "method": "GET",
      "path": "/attendancerecords/trend",
      "summary": "Get attendance trend data",
      "routeKey": "attendanceapi.GET._attendancerecords_trend"
    }
  ],
  "apiCall": {
    "service": "attendanceapi",
    "method": "GET",
    "path": "/attendancerecords/trend",
    "parameters": {
      "campusId": "main"
    },
    "headers": {
      "Authorization": "Bearer {jwt_token}",
      "Content-Type": "application/json"
    }
  },
  "explanation": "Selected attendance trend endpoint with campus filter",
  "confidence": 0.95
}
```

#### GET /query/available-routes
Returns all available routes with statistics.

**Response:**
```json
{
  "routes": [...], // All 315 routes
  "stats": {
    "totalRoutes": 315,
    "serviceBreakdown": {
      "attendanceapi": 52,
      "membershipapi": 41,
      "contentapi": 67,
      "givingapi": 58,
      "doingapi": 54,
      "messagingapi": 43
    },
    "methodBreakdown": {
      "GET": 189,
      "POST": 89,
      "DELETE": 37
    },
    "authRequiredCount": 315
  }
}
```

#### POST /query/search-routes
Search routes by keyword.

**Request:**
```json
{
  "searchTerm": "attendance"
}
```

**Response:**
```json
{
  "routes": [...], // Matching routes
  "count": 15,
  "searchTerm": "attendance"
}
```

#### GET /query/stats
Get system statistics.

**Response:**
```json
{
  "totalRoutes": 315,
  "serviceBreakdown": {...},
  "methodBreakdown": {...},
  "authRequiredCount": 315
}
```

## Data Structures

### RouteIndex (Lightweight Discovery)
```typescript
interface RouteIndex {
  service: string;           // "membershipapi", "attendanceapi"
  method: string;            // "GET", "POST", "PUT", "DELETE"
  path: string;              // "/people", "/attendancerecords/tree"
  summary: string;           // "Get all people", "Get attendance tree"
  tags: string[];            // ["People"], ["Attendance Records"]
  requiresAuth: boolean;     // true/false
  permissions: string[];     // ["attendance.viewSummary"]
  routeKey: string;          // Unique identifier for detail lookup
}
```

### RouteDetails (On-Demand Loading)
```typescript
interface RouteDetails {
  routeKey: string;
  parameters?: any[];        // Full parameter specifications
  requestBody?: any;         // Request schema
  responses?: any;           // Response schemas
  security?: any[];          // Security requirements
  examples?: any[];          // Usage examples
}
```

### QueryResult
```typescript
interface QueryResult {
  intent: string;            // What the user wants to do
  selectedRoutes: RouteIndex[]; // Relevant routes found
  apiCall?: {                // Generated API call
    service: string;
    method: string;
    path: string;
    parameters?: Record<string, any>;
    headers?: Record<string, string>;
  };
  explanation: string;       // How routes were selected
  confidence: number;        // Confidence score (0-1)
}
```

## Example Queries

### Attendance Queries
```json
// Query: "Show me attendance for last Sunday"
{
  "intent": "Get attendance records for a specific date",
  "routes": ["attendanceapi.GET._attendancerecords"],
  "apiCall": {
    "service": "attendanceapi",
    "method": "GET",
    "path": "/attendancerecords",
    "parameters": {
      "date": "2024-01-21"
    }
  }
}
```

### People Management
```json
// Query: "Find all people in the youth group"
{
  "intent": "Search for people in a specific group",
  "routes": ["membershipapi.GET._people"],
  "apiCall": {
    "service": "membershipapi",
    "method": "GET", 
    "path": "/people",
    "parameters": {
      "groupId": "youth"
    }
  }
}
```

### Giving Information
```json
// Query: "What were the donations this month?"
{
  "intent": "Get donation summary for current month",
  "routes": ["givingapi.GET._donations_summary"],
  "apiCall": {
    "service": "givingapi",
    "method": "GET",
    "path": "/donations/summary",
    "parameters": {
      "startDate": "2024-01-01",
      "endDate": "2024-01-31"
    }
  }
}
```

## Technical Implementation

### Service Classes

#### RouteDiscoveryService
- **Purpose**: Manages route indexing and search functionality
- **Key Methods**:
  - `loadRouteIndex()` - Load optimized route data
  - `searchRoutes(query)` - Natural language route search
  - `getRouteDetails(routeKey)` - Load detailed specifications
  - `getRoutesByService(serviceName)` - Filter by API service

#### OpenAIQueryService
- **Purpose**: Orchestrates OpenAI interactions for query processing
- **Key Methods**:
  - `processQuery(query, context)` - Main query processing
  - `analyzeQueryForRoutes()` - Find relevant routes using OpenAI
  - `generateApiCall()` - Create specific API call parameters

### Preprocessing Script
- **File**: `tools/preprocessSwagger.ts`
- **Command**: `npm run preprocess-swagger`
- **Output**: Optimized route index and detail files
- **Frequency**: Run when swagger files change

## Performance Characteristics

### Token Efficiency
- **Before**: 298KB swagger files = ~75,000 tokens
- **After**: 10-20KB route index = ~2,500-5,000 tokens
- **Savings**: 95% reduction in initial context size

### Response Times
- **Route Discovery**: < 100ms (local file access)
- **Detail Loading**: < 50ms per route (cached after first load)
- **OpenAI Processing**: 1-3 seconds (depends on query complexity)

### Caching Strategy
- Route details cached in memory after first load
- Route index loaded once at startup
- Cache can be cleared via `clearCache()` method

## Configuration

### Environment Variables
```bash
# Required for OpenAI integration
OPENAI_API_KEY=your_openai_api_key_here
```

### File Paths
- Route index: `config/optimized/route-index.json`
- Route details: `config/optimized/route-details/*.json`
- Can be customized in service constructors

## Error Handling

### Common Errors
1. **Route index not found**: Run `npm run preprocess-swagger`
2. **OpenAI API key missing**: Set `OPENAI_API_KEY` environment variable
3. **Route details missing**: Ensure preprocessing completed successfully

### Error Responses
```json
{
  "error": "Failed to discover routes",
  "details": "Route index not found. Run npm run preprocess-swagger first."
}
```

## Monitoring and Debugging

### Logging
- Route loading: Console logs show loaded route count
- Query processing: Detailed error logging for failed queries
- Cache operations: Debug information for cache hits/misses

### Statistics Endpoint
Use `GET /query/stats` to monitor:
- Total routes available
- Service distribution
- Method breakdown
- Authentication requirements

## Future Enhancements

### Planned Features
1. **Permission Integration**: Extract user permissions from authentication context
2. **Query History**: Track and learn from common query patterns
3. **Response Caching**: Cache API responses for identical queries
4. **Batch Operations**: Support multiple API calls in single query

### Extensibility Points
1. **Custom Prompt Templates**: Modify OpenAI prompts for specific domains
2. **Route Filtering**: Add custom filters for route discovery
3. **Response Transformation**: Post-process API responses
4. **Authentication Integration**: Connect with church management auth system

## Troubleshooting

### Build Issues
```bash
# Ensure TypeScript compilation works
npm run build

# Check for missing dependencies
npm install
```

### Runtime Issues
```bash
# Verify optimized files exist
ls config/optimized/

# Test route discovery
curl -X GET http://localhost:8080/query/stats
```

### OpenAI Integration
```bash
# Test basic connectivity
curl -X POST http://localhost:8080/query/discover-routes \
  -H "Content-Type: application/json" \
  -d '{"query": "test query"}'
```

## API Reference Summary

| Endpoint | Method | Purpose | Input | Output |
|----------|--------|---------|-------|--------|
| `/query/discover-routes` | POST | Convert natural language to API calls | `{query: string}` | `QueryResult` |
| `/query/available-routes` | GET | List all available routes | None | `{routes, stats}` |
| `/query/search-routes` | POST | Search routes by keyword | `{searchTerm: string}` | `{routes, count}` |
| `/query/stats` | GET | Get system statistics | None | `RouteStats` |

This system provides a complete solution for enabling OpenAI to intelligently query and interact with all microservice APIs in a token-efficient manner.